<%- include('../partials/header') %>

<div class="container py-5">
    <h1 class="mb-4">Checkout</h1>
    
    <% if (cart && cart.items && cart.items.length > 0) { %>
        <div class="checkout-container">
            <div class="row">
                <!-- Left Column: Shipping Address and Payment Method -->
                <div class="col-md-8 pe-md-4">
                    <!-- Shipping Address Form -->
                    <div class="address-form card shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Shipping Address</h5>
                            <form id="shipping-form">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="firstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="firstName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lastName" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="lastName" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" required>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="city" class="form-label">City</label>
                                        <input type="text" class="form-control" id="city" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="state" class="form-label">State</label>
                                        <input type="text" class="form-control" id="state" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="zipCode" class="form-label">ZIP Code</label>
                                        <input type="text" class="form-control" id="zipCode" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Payment Method (Mock) -->
                    <div class="payment-method card shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Payment Method</h5>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" checked>
                                <label class="form-check-label" for="cashOnDelivery">
                                    Cash on Delivery
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="stripe">
                                <label class="form-check-label" for="stripe">Pay by Card</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Order Summary -->
                <div class="col-md-4">
                    <!-- Order Summary -->
                    <div class="order-summary card shadow-sm mb-4 sticky-top sticky-offset">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Order Summary</h5>
                            
                            <div class="order-items mb-3">
                                <% cart.items.forEach(item => { %>
                                    <div class="order-item d-flex justify-content-between align-items-center mb-2">
                                        <div class="item-info d-flex align-items-center">
                                            <img src="<%= item.product.image %>" alt="<%= item.product.name %>" class="order-item-image">
                                            <div class="ms-3">
                                                <h6 class="mb-0"><%= item.product.name %></h6>
                                                <small class="text-muted">Qty: <%= item.quantity %></small>
                                            </div>
                                        </div>
                                        <div class="item-price">
                                            ₹<%= item.product.price * item.quantity %>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                            
                            <hr>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span>₹<%= cart.total %></span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Shipping:</span>
                                <span>₹0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tax:</span>
                                <span>₹<%= Math.round(cart.total * 0.05) %></span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3 fw-bold">
                                <span>Total:</span>
                                <span>₹<%= Math.round(cart.total * 1.05) %></span>
                            </div>
                            
                            <button id="place-order-btn" class="btn btn-success w-100">
                                <i class="fas fa-check-circle"></i> Place Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <% } else { %>
        <div class="empty-cart text-center py-5">
            <i class="fas fa-shopping-cart fa-4x mb-3 text-muted"></i>
            <h3>Your cart is empty</h3>
            <p class="text-muted">Add some items to your cart to proceed to checkout.</p>
            <a href="/shop" class="btn btn-primary mt-3">
                <i class="fas fa-store"></i> Continue Shopping
            </a>
        </div>
    <% } %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const placeOrderBtn = document.getElementById('place-order-btn');
    const codRadio = document.getElementById('cashOnDelivery');
    const cardRadio = document.getElementById('stripe');

    function updateCta() {
        const label = cardRadio && cardRadio.checked ? 'Pay Now' : 'Place Order';
        placeOrderBtn.innerHTML = `<i class="fas fa-check-circle"></i> ${label}`;
    }

    // Initialize button label based on selected method
    updateCta();
    // Update on change
    if (codRadio) codRadio.addEventListener('change', updateCta);
    if (cardRadio) cardRadio.addEventListener('change', updateCta);
    if (placeOrderBtn) {
        placeOrderBtn.addEventListener('click', function() {
            const form = document.getElementById('shipping-form');
            
            // Check if the form is valid
            if (form.checkValidity()) {
                // Show processing state
                placeOrderBtn.disabled = true;
                placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                // Get form data
                const formData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipCode: document.getElementById('zipCode').value,
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').id
                };
                
                const payWithStripe = document.getElementById('stripe').checked;
                if (payWithStripe) {
                    fetch('/payments/create-shop-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    })
                    .then(r => r.json().then(d => { if (!r.ok || !d.success) { throw new Error(d.message || 'Failed to start payment'); } return d; }))
                    .then(d => {
                        const url = d.data && d.data.url;
                        if (!url) throw new Error('Invalid checkout URL');
                        window.location.href = url;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        placeOrderBtn.disabled = false;
                        updateCta();
                        alert('Error: ' + (error.message || 'There was an error starting payment.'));
                    });
                } else {
                    // COD flow uses existing order creation
                    fetch('/cart/create-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    })
                    .then(response => response.json().then(data => { if (!response.ok) { throw new Error(data.message || 'Failed to create order'); } return data; }))
                    .then(data => {
                        if (!data.success) throw new Error(data.message || 'Failed to process order');
                        return fetch('/cart/clear', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                    })
                    .then(resp => { if (!resp.ok) throw new Error('Failed to clear cart'); return resp.json(); })
                    .then(() => { alert('Order placed successfully!'); window.location.href = '/orders'; })
                    .catch(error => {
                        console.error('Error:', error);
                        placeOrderBtn.disabled = false;
                        updateCta();
                        alert('Error: ' + (error.message || 'There was an error processing your order. Please try again.'));
                    });
                }
            } else {
                // Trigger browser's native form validation
                form.reportValidity();
            }
        });
    }
});
</script>

<style>
.checkout-container {
    width: 100%;
    margin: 0 auto;
}

.order-item-image {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
}

.empty-cart {
    color: #6c757d;
}

.empty-cart i {
    opacity: 0.5;
}

.sticky-offset {
    top: 20px;
}

@media (max-width: 768px) {
    .sticky-top {
        position: relative;
    }
}

.card {
    background-color: #222;
    border: 1px solid #333;
    border-radius: 8px;
}

.card-title {
    color: #f8f9fa;
    font-weight: 600;
}
</style>

<%- include('../partials/footer') %> 