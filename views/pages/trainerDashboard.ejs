<%- include('../partials/header') %>

<main>
  <div class="container my-5">
    <div class="dashboard-welcome">
      <h2 class="mb-4">
        <i class="fas fa-chart-line me-2"></i>Hello, <%= locals.userName %>!
      </h2>
      <p class="lead mb-4 text-white">Welcome to your trainer dashboard. Manage your clients and schedule from here.</p>
    </div>
    
    <div class="row g-4">
      <!-- Sessions Stats Card -->
      <div class="col-lg-4">
        <div class="dashboard-panel">
          <h4 class="text-danger mb-4"><i class="fas fa-chart-pie me-2"></i>Sessions Overview</h4>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-light">Today's Sessions:</span>
            <span class="dashboard-stat text-danger fw-bold fs-4" id="todaySessions" data-target="<%= stats.todayBookings || 0 %>"><%= stats.todayBookings || 0 %></span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-light">Week's Sessions:</span>
            <span class="dashboard-stat text-danger fw-bold fs-4" id="totalSessions" data-target="<%= stats.totalBookings || 0 %>"><%= stats.totalBookings || 0 %></span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-light">Total Clients:</span>
            <span class="dashboard-stat text-danger fw-bold fs-4" id="totalClients" data-target="<%= stats.clientCount || 0 %>"><%= stats.clientCount || 0 %></span>
          </div>
        </div>
      </div>
      
      <!-- Today's Schedule -->
      <div class="col-lg-8">
        <div class="dashboard-section mb-4">
          <div class="section-header mb-3">
            <h3><i class="fas fa-calendar-day me-2"></i>Today's Schedule</h3>
          </div>
          
          <div class="schedule-container">
            <div class="table-responsive" id="todayScheduleTable">
              <table class="table table-dark table-hover">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Course</th>
                  </tr>
                </thead>
                <tbody id="todayScheduleBody">
                  <% 
                  // Get today's day of the week
                  const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                  const today = daysOfWeek[new Date().getDay()];
                  
                  let todayClasses = [];
                  
                  // If server-provided today schedule exists, use it
                  if (locals.todaySchedule && locals.todaySchedule.length > 0) { 
                    todayClasses = locals.todaySchedule.map(session => ({
                      time: session.time,
                      program: session.program
                    }));
                  } 
                  // Otherwise, filter from weekly schedule if available
                  else if (locals.weeklySchedule && locals.weeklySchedule.length > 0) {
                    todayClasses = locals.weeklySchedule
                      .filter(session => session.day.toLowerCase() === today)
                      .map(session => ({
                        time: session.time,
                        program: session.course.charAt(0).toUpperCase() + session.course.slice(1)
                      }));
                  }
                  
                  // Sort by time
                  todayClasses.sort((a, b) => {
                    const timeA = a.time.split(' - ')[0];
                    const timeB = b.time.split(' - ')[0];
                    return timeA.localeCompare(timeB);
                  });
                  
                  if (todayClasses.length > 0) {
                    todayClasses.forEach(session => { %>
                      <tr>
                        <td><strong><%= session.time %></strong></td>
                        <td>
                          <span class="course-badge <%= session.program.toLowerCase().includes('yoga') ? 'bg-success' : 
                                                        session.program.toLowerCase().includes('zumba') ? 'bg-info' : 
                                                        'bg-warning' %>">
                            <%= session.program %>
                          </span>
                        </td>
                      </tr>
                    <% });
                  } else { %>
                    <tr>
                      <td colspan="2">
                        <div class="alert alert-info mb-0">
                          <i class="fas fa-info-circle me-2"></i>No sessions scheduled for today.
                        </div>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Weekly Schedule -->
      <div class="col-12">
        <div class="dashboard-section mb-4">
          <div class="section-header mb-3">
            <h3><i class="fas fa-calendar-week me-2"></i>Weekly Schedule</h3>
          </div>
          
          <div class="schedule-container">
            <% if (locals.weeklySchedule && locals.weeklySchedule.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-dark table-hover">
                  <thead class="bg-primary text-white">
                    <tr>
                      <th>No.</th>
                      <th>Day</th>
                      <th>Time</th>
                      <th>Course</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% locals.weeklySchedule.forEach(session => { %>
                      <tr>
                        <td><%= session.sno %></td>
                        <td><%= session.day %></td>
                        <td><%= session.time %></td>
                        <td>
                          <span class="course-badge <%= session.course === 'yoga' ? 'bg-success' : 
                                                        session.course === 'zumba' ? 'bg-info' : 
                                                        'bg-warning' %>">
                            <%= session.course.charAt(0).toUpperCase() + session.course.slice(1) %>
                          </span>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>You don't have any courses assigned to your schedule yet.
              </div>
            <% } %>
          </div>
        </div>
      </div>
      
      <!-- Client Management -->
      <div class="col-12">
        <div class="dashboard-section">
          <div class="section-header mb-3">
            <h3><i class="fas fa-users me-2"></i>Your Clients</h3>
          </div>
          
          <div class="table-responsive">
            <% if (locals.clients && locals.clients.length > 0) { %>
              <table class="table table-dark table-hover">
                <thead class="bg-primary text-white">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Course</th>
                    <th>Enrolled On</th>
                    <th>Expires</th>
                    <th>Days Left</th>
                  </tr>
                </thead>
                <tbody>
                  <% locals.clients.forEach(client => { %>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <% if (client.profilePicture) { %>
                            <img src="<%= client.profilePicture %>" class="rounded-circle me-2" width="32" height="32" alt="<%= client.name %>">
                          <% } else { %>
                            <div class="rounded-circle bg-secondary me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                              <i class="fas fa-user text-light"></i>
                            </div>
                          <% } %>
                          <%= client.name %>
                        </div>
                      </td>
                      <td><%= client.email %></td>
                      <td>
                        <span class="course-badge <%= client.course.name === 'yoga' ? 'bg-success' : 
                                                      client.course.name === 'zumba' ? 'bg-info' : 
                                                      'bg-warning' %>">
                          <%= client.course.name.charAt(0).toUpperCase() + client.course.name.slice(1) %>
                        </span>
                      </td>
                      <td><%= new Date(client.enrolledAt).toLocaleDateString() %></td>
                      <td><%= new Date(client.endDate).toLocaleDateString() %></td>
                      <td>
                        <% if (client.remainingDays <= 7) { %>
                          <span class="badge bg-danger"><%= client.remainingDays %> days</span>
                        <% } else { %>
                          <span class="badge bg-success"><%= client.remainingDays %> days</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            <% } else { %>
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>You don't have any clients assigned yet. 
                Clients will appear here when they book courses with you.
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Session Notes Modal -->
<div class="modal fade" id="sessionNotesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-sticky-note me-2"></i>Session Notes</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="sessionNotesForm" action="/trainer/update-notes" method="POST">
          <input type="hidden" id="sessionId" name="sessionId">
          
          <div class="mb-3">
            <label for="sessionNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="sessionNotes" name="notes" rows="5"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" form="sessionNotesForm" class="btn btn-danger">Save Notes</button>
      </div>
    </div>
  </div>
</div>

<!-- Script for Session Notes Modal & Dashboard Data -->
<script>
  // Set session data in the modal when opened
  document.getElementById('sessionNotesModal')?.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const sessionId = button.getAttribute('data-session-id');
    const sessionNotes = button.getAttribute('data-session-notes');
    
    document.getElementById('sessionId').value = sessionId;
    document.getElementById('sessionNotes').value = sessionNotes;
  });
  
  // Update stats based on client-side calculations
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded, starting session calculations");
    
    // Direct DOM references for session count elements
    const todaySessionsElement = document.getElementById('todaySessions');
    const totalSessionsElement = document.getElementById('totalSessions');
    const totalClientsElement = document.getElementById('totalClients');
    
    if (!todaySessionsElement || !totalSessionsElement) {
      console.error("Session count elements not found");
      return;
    }
    
    // Get today's day of the week (0 = Sunday, 1 = Monday, etc.)
    const now = new Date();
    const today = now.getDay();
    const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const todayString = daysOfWeek[today];
    
    console.log("Today is:", todayString, "(Day index:", today, ")");
    
    // Get server-provided counts from data attributes
    const serverTodaySessions = parseInt(todaySessionsElement.getAttribute('data-target') || '0');
    const serverTotalSessions = parseInt(totalSessionsElement.getAttribute('data-target') || '0');
    const serverTotalClients = totalClientsElement ? parseInt(totalClientsElement.getAttribute('data-target') || '0') : 0;
    
    console.log("Server provided counts - Today:", serverTodaySessions, "Total:", serverTotalSessions, "Clients:", serverTotalClients);
    
    // If server provided valid counts, use those first
    if (serverTodaySessions > 0 || serverTotalSessions > 0) {
      console.log("Using server-provided counts");
      
      todaySessionsElement.textContent = serverTodaySessions;
      totalSessionsElement.textContent = serverTotalSessions;
      
      if (totalClientsElement) {
        totalClientsElement.textContent = serverTotalClients;
      }
      
      // Add visual feedback
      const countElements = [todaySessionsElement, totalSessionsElement, totalClientsElement].filter(el => el);
      countElements.forEach(el => {
        el.classList.add('text-danger', 'fw-bold');
      });
      
      // Stop here if server provided good counts
      return;
    }
    
    // Otherwise, fallback to client-side counting
    console.log("Falling back to client-side counting");
    
    // ----- COUNT TODAY'S SESSIONS -----
    
    // Method 1: Count sessions in the Today's Schedule section
    let todaySessionsFromTable = 0;
    
    // Find the Today's Schedule table 
    const todaySection = document.querySelector('.dashboard-section:first-of-type');
    const todayTable = todaySection?.querySelector('table');
    console.log("Today's schedule section found:", !!todaySection);
    console.log("Today's schedule table found:", !!todayTable);
    
    if (todayTable) {
      // Count all table rows that don't contain the "No sessions" message
      const todayRows = Array.from(todayTable.querySelectorAll('tbody tr'));
      console.log("Today's schedule rows found:", todayRows.length);
      
      todayRows.forEach((row, i) => {
        // Check if this is not the "No sessions" message row
        const alertDiv = row.querySelector('.alert-info');
        if (!alertDiv) {
          todaySessionsFromTable++;
          console.log(`Row ${i+1} is a valid session row`);
        } else {
          console.log(`Row ${i+1} contains alert message, not counting`);
        }
      });
    }
    
    console.log("Today's sessions from table:", todaySessionsFromTable);
    
    // Method 2: Count by filtering the weekly schedule
    let weeklySessionsCount = 0;
    let todaySessionsFromWeekly = 0;
    
    // Find the Weekly Schedule table
    const weeklySection = document.querySelector('h3 i.fa-calendar-week, h3 i.fas.fa-calendar-week')?.closest('.dashboard-section');
    const weeklyTable = weeklySection?.querySelector('table');
    console.log("Weekly schedule section found:", !!weeklySection);
    console.log("Weekly schedule table found:", !!weeklyTable);
    
    if (weeklyTable) {
      const weeklyRows = Array.from(weeklyTable.querySelectorAll('tbody tr'));
      weeklySessionsCount = weeklyRows.length;
      console.log("Weekly schedule rows found:", weeklyRows.length);
      
      weeklyRows.forEach((row, i) => {
        // The day is in the second cell (index 1)
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          const dayText = cells[1].textContent.trim();
          console.log(`Row ${i+1} day: "${dayText}"`);
          
          // Case-insensitive comparison with the day
          if (dayText.toLowerCase() === todayString.toLowerCase()) {
            todaySessionsFromWeekly++;
            console.log(`Row ${i+1} is for today (${todayString})`);
          }
        }
      });
    }
    
    console.log("Today's sessions from weekly schedule:", todaySessionsFromWeekly);
    console.log("Total weekly sessions:", weeklySessionsCount);
    
    // Use the maximum count found by either method
    const todaySessionsFinal = Math.max(todaySessionsFromTable, todaySessionsFromWeekly);
    console.log("Final today's sessions count:", todaySessionsFinal);
    
    // ----- COUNT CLIENTS -----
    let totalClients = 0;
    
    // Find the Your Clients table
    const clientsSection = document.querySelector('h3 i.fa-users, h3 i.fas.fa-users')?.closest('.dashboard-section');
    const clientsTable = clientsSection?.querySelector('table');
    console.log("Clients section found:", !!clientsSection);
    console.log("Clients table found:", !!clientsTable);
    
    if (clientsTable) {
      const clientRows = Array.from(clientsTable.querySelectorAll('tbody tr'));
      totalClients = clientRows.length;
      console.log("Client rows found:", clientRows.length);
    }
    
    // ----- UPDATE THE DISPLAYED COUNTS -----
    
    // Update today's sessions count if we found sessions
    if (todaySessionsFinal > 0 || parseInt(todaySessionsElement.textContent) !== todaySessionsFinal) {
      console.log("Updating today's sessions count to:", todaySessionsFinal);
      todaySessionsElement.textContent = todaySessionsFinal;
      todaySessionsElement.classList.add('text-danger', 'fw-bold');
    }
    
    // Update total sessions count if we found sessions
    if (weeklySessionsCount > 0 || parseInt(totalSessionsElement.textContent) !== weeklySessionsCount) {
      console.log("Updating total sessions count to:", weeklySessionsCount);
      totalSessionsElement.textContent = weeklySessionsCount;
      totalSessionsElement.classList.add('text-danger', 'fw-bold');
    }
    
    // Update total clients count if we found clients
    if (totalClientsElement && (totalClients > 0 || parseInt(totalClientsElement.textContent) !== totalClients)) {
      console.log("Updating total clients count to:", totalClients);
      totalClientsElement.textContent = totalClients;
      totalClientsElement.classList.add('text-danger', 'fw-bold');
    }
    
    console.log("Session calculations complete");
  });
</script>

<style>
  .course-badge {
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
  }
  
  /* Animation for dashboard stats */
  @keyframes countAnimation {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); }
  }
  
  .dashboard-stat {
    transition: all 0.3s ease;
    display: inline-block;
  }
  
  .dashboard-stat.text-danger {
    animation: countAnimation 0.5s ease-in-out;
  }
</style>

<%- include('../partials/footer') %>