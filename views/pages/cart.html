<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Cart - FitSync</title>
  <!-- Bootstrap & Font Awesome (to match existing UI classes) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Project styles -->
  <link href="/css/styles.css" rel="stylesheet">
  <style>
    .cart-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
    .cart-item { border-radius: 8px; overflow: hidden; }
    .product-meta { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
    .meta-item { display: flex; align-items: center; font-size: 0.85rem; color: #6c757d; }
    .meta-item i { margin-right: 5px; }
    .stock-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; }
    .stock-available { background-color: #d4edda; color: #155724; }
    .stock-low { background-color: #fff3cd; color: #856404; }
    .stock-out { background-color: #f8d7da; color: #721c24; font-weight: bold; }
    .quantity-controls { display: flex; align-items: center; }
    .quantity-value { width: 30px; text-align: center; }
    .cart-summary { border-radius: 8px; position: sticky; top: 20px; height: fit-content; }
    @media (max-width: 991px) { .cart-container { grid-template-columns: 1fr; } }
    .empty-cart { color: #6c757d; }
    .empty-cart i { opacity: 0.5; }
  </style>
  <script>
    async function fetchCart() {
      // JSON endpoint is mounted at /api/shop/cart/api
      const res = await fetch('/api/shop/cart/api', { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('Failed to fetch cart');
      const body = await res.json();
      return body.data || { items: [], total: 0 };
    }

    function formatCurrency(n) { return `â‚¹${n}`; }

    function renderEmpty(container) {
      container.innerHTML = `
        <div class="empty-cart text-center py-5">
          <i class="fas fa-shopping-cart fa-4x mb-3 text-muted"></i>
          <h3>Your cart is empty</h3>
          <p class="text-muted">Add some items to your cart to see them here.</p>
          <a href="/shop" class="btn btn-primary mt-3">
            <i class="fas fa-store"></i> Continue Shopping
          </a>
        </div>
      `;
    }

    function computeTotals(cart) {
      const subtotal = cart.total || 0;
      const tax = Math.round(subtotal * 0.05);
      const shipping = 0;
      const total = subtotal + tax + shipping;
      return { subtotal, tax, shipping, total };
    }

    function bindItemEvents(itemEl, productId) {
      const minus = itemEl.querySelector('[data-action="decrease"]');
      const plus = itemEl.querySelector('[data-action="increase"]');
      const qtySpan = itemEl.querySelector('.quantity-value');
      const removeBtn = itemEl.querySelector('[data-remove]');

      async function updateQuantity(newQty) {
        if (newQty < 1) { await removeItem(); return; }
        const res = await fetch(`/api/shop/cart/${productId}/quantity`, {
          method: 'PATCH', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: newQty })
        });
        if (!res.ok) { const e = await res.json().catch(()=>({})); alert(e.message || 'Failed to update'); return; }
        const body = await res.json();
        renderCart(body.data);
      }

      async function removeItem() {
        const res = await fetch(`/api/shop/cart/${productId}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
        if (!res.ok) { const e = await res.json().catch(()=>({})); alert(e.message || 'Failed to remove'); return; }
        const body = await res.json();
        renderCart(body.data);
      }

      minus?.addEventListener('click', () => {
        const current = parseInt(qtySpan.textContent || '1', 10);
        updateQuantity(current - 1);
      });
      plus?.addEventListener('click', () => {
        const current = parseInt(qtySpan.textContent || '1', 10);
        updateQuantity(current + 1);
      });
      removeBtn?.addEventListener('click', removeItem);
    }

    function renderCart(cart) {
      const root = document.getElementById('root');
      if (!cart || !cart.items || cart.items.length === 0) { renderEmpty(root); return; }

      // Build items markup
      const itemsHtml = cart.items.map(item => {
        const p = item.product || {};
        const priceEach = p.price || 0;
        const quantity = item.quantity || 1;
        const lineTotal = priceEach * quantity;
        const stock = typeof p.stock === 'number' ? p.stock : 0;
        const stockBadge = stock <= 0 ? '<span class="stock-badge stock-out">Out of stock</span>' : '';
        const plusDisabled = stock <= 0 ? 'disabled' : '';
        return `
          <div class="cart-item card mb-3 shadow-sm" data-product-id="${p._id}">
            <div class="row g-0">
              <div class="col-md-2">
                <img src="${p.image || ''}" class="img-fluid rounded-start" alt="${p.name || ''}" style="max-height: 150px; object-fit: cover;">
              </div>
              <div class="col-md-7">
                <div class="card-body">
                  <h5 class="card-title">${p.name || ''}</h5>
                  <p class="card-text text-muted">${p.description || ''}</p>
                  <div class="product-meta">
                    <div class="meta-item"><i class="fas fa-box"></i><span>${p.category || ''}</span></div>
                    ${stockBadge}
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card-body d-flex flex-column justify-content-between h-100">
                  <div class="price-container text-end">
                    <h5 class="fw-bold mb-0">${formatCurrency(lineTotal)}</h5>
                    <small class="text-muted">${formatCurrency(priceEach)} each</small>
                  </div>
                  <div class="quantity-controls d-flex justify-content-end align-items-center mt-2">
                    <button class="btn btn-sm btn-outline-secondary" data-action="decrease"><i class="fas fa-minus"></i></button>
                    <span class="quantity-value mx-2">${quantity}</span>
                    <button class="btn btn-sm btn-outline-secondary" data-action="increase" ${plusDisabled}><i class="fas fa-plus"></i></button>
                  </div>
                  <button class="btn btn-danger mt-2 w-100" data-remove><i class="fas fa-trash"></i> REMOVE</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      const totals = computeTotals(cart);
      root.innerHTML = `
        <div class="container py-5">
          <h1 class="mb-4">My Shopping Cart</h1>
          <div class="cart-container">
            <div id="items" class="cart-items mb-4">${itemsHtml}</div>
            <div class="cart-summary card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">Order Summary</h5>
                <div class="d-flex justify-content-between mb-2"><span>Subtotal:</span><span id="subtotal">${formatCurrency(totals.subtotal)}</span></div>
                <div class="d-flex justify-content-between mb-2"><span>Shipping:</span><span id="shipping">${formatCurrency(totals.shipping)}</span></div>
                <div class="d-flex justify-content-between mb-2"><span>Tax:</span><span id="tax">${formatCurrency(totals.tax)}</span></div>
                <hr />
                <div class="d-flex justify-content-between mb-2 fw-bold"><span>Total:</span><span id="total">${formatCurrency(totals.total)}</span></div>
                <a href="/cart/checkout" class="btn btn-primary w-100 mt-3"><i class="fas fa-shopping-cart"></i> Proceed to Checkout</a>
              </div>
            </div>
          </div>
        </div>
      `;

      // Bind events for each item after rendering
      document.querySelectorAll('[data-product-id]').forEach(el => {
        const productId = el.getAttribute('data-product-id');
        bindItemEvents(el, productId);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const root = document.getElementById('root');
      root.innerHTML = '<div class="container py-5 text-center text-muted"><div class="spinner-border" role="status"></div><p class="mt-2">Loading your cart...</p></div>';
      try { const cart = await fetchCart(); renderCart(cart); } catch (e) { root.innerHTML = '<div class="container py-5 text-center text-danger">Failed to load cart.</div>'; }
    });
  </script>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
