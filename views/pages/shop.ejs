<%- include('../partials/header') %>

<% var cart = typeof cart !== 'undefined' ? cart : null; %>

<div class="container py-5">
    <h1 class="mb-4">Shop</h1>
    
    <div class="row">
        <% if (products && products.length > 0) { %>
            <% products.forEach(product => { %>
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <img src="<%= product.image.startsWith('/') ? product.image : '/' + product.image %>" class="card-img-top" alt="<%= product.name %>" 
                             style="height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title"><%= product.name %></h5>
                            <p class="card-text text-muted"><%= product.description %></p>
                            <div class="d-flex flex-column align-items-start w-100">
                                <div class="d-flex justify-content-between w-100 align-items-center mb-3">
                                    <h5 class="mb-0">
                                        <span class="product-price">â‚¹<%= product.price %></span>
                                    </h5>
                                    <% if (product.stock <= 0) { %>
                                        <span class="stock-badge stock-out">Out of Stock</span>
                                    <% } %>
                                </div>
                                <% if (cart && cart.items && cart.items.find(item => item.product.toString() === product._id.toString())) { %>
                                    <% const cartItem = cart.items.find(item => item.product.toString() === product._id.toString()); %>
                                    <div class="quantity-controls mb-2">
                                        <button class="quantity-btn" data-quantity="<%= cartItem.quantity || 1 %>" onclick='<% if (!isLoggedIn) { %>window.location.href="/auth/login?returnTo=/shop"<% } else { %>updateCartQuantity("<%= product._id %>", -1, "<%= cartItem.quantity %>")<% } %>' <%= product.stock <= 0 ? 'disabled' : '' %>><i class="fas fa-minus"></i></button>
                                        <span class="quantity-value"><%= cartItem.quantity || 1 %></span>
                                        <button class="quantity-btn" data-quantity="<%= cartItem.quantity || 1 %>" onclick='<% if (!isLoggedIn) { %>window.location.href="/auth/login?returnTo=/shop"<% } else { %>updateCartQuantity("<%= product._id %>", 1, "<%= cartItem.quantity %>")<% } %>' <%= product.stock <= 0 ? 'disabled' : '' %>><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn btn-danger" onclick='<% if (!isLoggedIn) { %>window.location.href="/auth/login?returnTo=/shop"<% } else { %>removeFromCart("<%= product._id %>")<% } %>'>
                                            <i class="fas fa-trash"></i> Remove from Cart
                                        </button>
                                        <form action="/cart/buy-now/<%= product._id %>" method="post">
                                            <button type="submit" class="btn btn-primary" <%= product.stock <= 0 ? 'disabled' : '' %> onclick="return checkLoginForBuyNow()">
                                                <i class="fas fa-shopping-cart"></i> Buy Now
                                            </button>
                                        </form>
                                    </div>
                                <% } else { %>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary" onclick='<% if (!isLoggedIn) { %>showLoginAlert()<% } else { %>addToCart("<%= product._id %>")<% } %>' <%= product.stock <= 0 ? 'disabled' : '' %>>
                                            <i class="fas fa-cart-plus"></i> Add to Cart
                                        </button>
                                        <form action="/cart/buy-now/<%= product._id %>" method="post">
                                            <button type="submit" class="btn btn-primary" <%= product.stock <= 0 ? 'disabled' : '' %> onclick="return checkLoginForBuyNow()">
                                                <i class="fas fa-shopping-cart"></i> Buy Now
                                            </button>
                                        </form>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="col-12">
                <div class="alert alert-info">
                    No products available at the moment.
                </div>
            </div>
        <% } %>
    </div>
</div>

<div id="user-auth-data" data-is-logged-in="<%= isLoggedIn ? 'true' : 'false' %>" data-login-url="/auth/login?returnTo=/shop"></div>

<script>
// Initialize variables
let isUserLoggedIn = false;
let loginReturnUrl = "/auth/login?returnTo=/shop";

// Make sure DOM is loaded before accessing elements
document.addEventListener('DOMContentLoaded', function() {
    // Get login status from data attribute
    const authData = document.getElementById('user-auth-data');
    if (authData) {
        isUserLoggedIn = authData.dataset.isLoggedIn === 'true';
        loginReturnUrl = authData.dataset.loginUrl;
        console.log('Auth data loaded:', isUserLoggedIn, loginReturnUrl);
    } else {
        console.error('Auth data element not found!');
    }
});

// Add to cart function
async function addToCart(productId) {
    // Redirect to login if not logged in
    if (!isUserLoggedIn) {
        window.location.href = loginReturnUrl;
        return;
    }
    
    try {
        const response = await fetch('/api/shop/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productId })
        });
        const data = await response.json();
        
        if (response.ok) {
            alert('Product added to cart!');
            window.location.reload();
        } else {
            alert(data.message || 'Failed to add product to cart');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to add product to cart');
    }
}

// Update cart quantity
async function updateCartQuantity(productId, delta, currentQuantity) {
    // Redirect to login if not logged in
    if (!isUserLoggedIn) {
        window.location.href = loginReturnUrl;
        return;
    }
    
    currentQuantity = parseInt(currentQuantity, 10);
    const newQuantity = currentQuantity + delta;
    if (newQuantity < 1) {
        await removeFromCart(productId);
        return;
    }
    try {
        const response = await fetch(`/api/shop/cart/${productId}/quantity`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity: newQuantity })
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.message || 'Failed to update cart quantity');
        }
    } catch (error) {
        alert('Failed to update cart quantity');
    }
}

// Remove from cart
async function removeFromCart(productId) {
    // Redirect to login if not logged in
    if (!isUserLoggedIn) {
        window.location.href = loginReturnUrl;
        return;
    }
    
    try {
        const response = await fetch(`/api/shop/cart/${productId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.message || 'Failed to remove from cart');
        }
    } catch (error) {
        alert('Failed to remove from cart');
    }
}

// Buy now function
async function buyNow(productId) {
    // Check login status first
    if (!checkLoginForBuyNow()) {
        return;
    }
    
    try {
        // First clear cart
        const clearResponse = await fetch('/cart/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!clearResponse.ok) {
            throw new Error('Failed to clear cart');
        }
        
        // Then add this product to cart
        const addResponse = await fetch('/api/shop/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productId })
        });
        
        if (!addResponse.ok) {
            throw new Error('Failed to add product to cart');
        }
        
        // Redirect to checkout page
        window.location.href = '/cart/checkout';
    } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'Failed to process purchase');
    }
}

function showLoginAlert() {
    alert('Please login before adding items to your cart');
    window.location.href = '/auth/login?returnTo=/shop';
}

function checkLoginForBuyNow() {
    if (!isUserLoggedIn) {
        alert('Please login before making a purchase');
        window.location.href = '/auth/login?returnTo=/shop';
        return false;
    }
    return true;
}
</script>

<%- include('../partials/footer') %>

<style>
.cart-controls {
    margin-top: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}
.quantity-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--main-accent);
    border-radius: 8px;
    background: linear-gradient(90deg, #222 0%, #444 100%);
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    overflow: hidden;
    width: 100%;
}
.quantity-btn {
    width: 48px;
    height: 48px;
    background: var(--main-accent);
    border: none;
    color: #fff;
    font-size: 1.6rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}
.quantity-btn:disabled {
    background: #666;
    cursor: not-allowed;
    opacity: 0.7;
}
.quantity-btn:hover:not(:disabled) {
    background: var(--red);
}
.quantity-btn i {
    color: #fff !important;
    font-size: 1.6rem;
    pointer-events: none;
}
.quantity-value {
    min-width: 56px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-weight: 600;
    color: var(--main-accent);
    font-size: 1.4rem;
    background: #000;
    padding: 0 1rem;
    border-radius: 0;
}
.btn-add-cart {
    background: var(--main-accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.7rem 1.5rem;
    font-weight: 600;
    transition: background 0.2s;
}
.btn-add-cart:hover {
    background: var(--red);
}
.btn-remove-cart {
    background: var(--red);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.7rem 1.5rem;
    font-weight: 600;
    transition: background 0.2s;
}
.btn-remove-cart:hover {
    background: var(--main-accent);
}
.cart-total {
    color: var(--main-accent);
    font-weight: 700;
    font-size: 1.1rem;
    margin-left: 1rem;
}
.card.h-100.shadow-sm {
    min-height: 480px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.action-buttons {
    display: flex;
    width: 100%;
    margin-top: 0.5rem;
    gap: 0.5rem;
}
.action-buttons .btn {
    flex: 1 1 0;
    min-width: 0;
    padding: 0.5rem;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 46px;
}
.action-buttons form {
    flex: 1;
    display: flex;
}
.action-buttons form button {
    flex: 1;
    width: 100%;
}
.action-buttons .btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}
@media (max-width: 600px) {
    .action-buttons {
        flex-direction: column;
        gap: 0.5rem;
    }
    .action-buttons form {
        width: 100%;
    }
}
.card .card-body h5.mb-0 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
    background: var(--main-accent);
    padding: 0.3rem 1rem;
    border-radius: 8px;
    display: inline-block;
}
.stock-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: bold;
}
.stock-out {
    background-color: #f8d7da;
    color: #721c24;
}
</style> 