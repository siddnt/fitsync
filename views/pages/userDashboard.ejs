<%- include('../partials/header') %>

  <main>
    <div class="container my-5">
      <% if (locals.flashMessage && locals.flashType === 'success') { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i><%= flashMessage %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      <div class="dashboard-welcome">
        <h2 class="mb-4">
          <i class="fas fa-chart-line me-2"></i>Hello, <%= user.name %>!
        </h2>
        <p class="lead mb-4">Welcome to your fitness dashboard. Track your progress and manage your fitness journey.</p>
      </div>
      <div class="row">
        <!-- Enrolled Courses Section -->
        <div class="col-md-8">
          <div class="card mb-4">
            <div class="card-header bg-danger text-white">
              <h3>My Courses</h3>
            </div>
            <div class="card-body">
              <div class="dashboard-section">
                <div class="section-header mb-3 d-flex justify-content-between align-items-center">
                  <h4><i class="fas fa-calendar-alt me-2"></i>My Course Enrollments</h4>
                  <a href="/courses" class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-plus me-1"></i> Browse Courses
                  </a>
                </div>
                
                <div class="row">
                  <% if (enrolledCourses && enrolledCourses.length > 0) { %>
                    <% enrolledCourses.forEach(enrollment => { %>
                      <div class="col-md-6 mb-4">
                        <div class="card course-enrollment-card h-100">
                          <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><%= enrollment.courseName %></h5>
                            <% if (enrollment.isActive) { %>
                              <span class="badge bg-success">Active</span>
                            <% } else if (new Date() > enrollment.endDate) { %>
                              <span class="badge bg-secondary">Expired</span>
                            <% } else { %>
                              <span class="badge bg-warning">Pending</span>
                            <% } %>
                          </div>
                          <div class="card-body">
                            <div class="mb-3">
                              <strong><i class="fas fa-user-tie me-2"></i>Trainer:</strong>
                              <p class="mb-0"><%= enrollment.trainerName %></p>
                            </div>
                            
                            <% if (enrollment.isActive) { %>
                              <div class="mb-3">
                                <strong><i class="fas fa-clock me-2"></i>Expires In:</strong>
                                <p class="mb-0 <%= enrollment.daysLeft < 7 ? 'text-danger' : '' %>">
                                  <%= enrollment.daysLeft %> days
                                </p>
                              </div>
                            <% } %>
                            
                            <% if (enrollment.courseSchedule && enrollment.courseSchedule.length > 0) { %>
                              <div class="mb-3">
                                <strong><i class="fas fa-calendar-week me-2"></i>Weekly Schedule:</strong>
                                <ul class="list-unstyled schedule-list">
                                  <% 
                                  const dayOrder = {
                                    monday: 1, tuesday: 2, wednesday: 3, thursday: 4, friday: 5, saturday: 6, sunday: 7
                                  };
                                  
                                  const sortedSchedule = [...enrollment.courseSchedule].sort((a, b) => {
                                    return dayOrder[a.day] - dayOrder[b.day];
                                  });
                                  
                                  sortedSchedule.slice(0, 3).forEach(session => { %>
                                    <li>
                                      <i class="fas fa-clock-rotate-left me-1 text-muted"></i>
                                      <%= session.day.charAt(0).toUpperCase() + session.day.slice(1) %>: 
                                      <%= session.startTime %> - <%= session.endTime %>
                                    </li>
                                  <% }); %>
                                  
                                  <% if (sortedSchedule.length > 3) { %>
                                    <li><small class="text-muted">+ <%= sortedSchedule.length - 3 %> more sessions</small></li>
                                  <% } %>
                                </ul>
                              </div>
                            <% } %>
                            
                            <div class="d-grid gap-2 mt-3">
                              <% if (enrollment.isActive && enrollment.daysLeft < 14) { %>
                                <button class="btn btn-sm btn-outline-success renew-btn" 
                                        data-enrollment-id="<%= enrollment._id %>">
                                  <i class="fas fa-sync-alt me-1"></i>Renew Enrollment
                                </button>
                              <% } %>
                              <% if (enrollment.isActive) { %>
                                <button class="btn btn-sm btn-outline-primary write-review-btn"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#reviewModal"
                                        data-course-id="<%= enrollment.course._id %>"
                                        data-course-name="<%= enrollment.courseName %>">
                                  <i class="fas fa-star me-1"></i>Write a Review
                                </button>
                              <% } %>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% }); %>
                  <% } else { %>
                    <div class="col-12">
                      <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>You haven't enrolled in any courses yet. 
                        <a href="/courses" class="alert-link">Browse our courses</a> to get started!
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-danger text-white">
              <h3>Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="list-group">
                <a href="/courses" class="list-group-item list-group-item-action">
                  <i class="fas fa-calendar-plus me-2"></i>Explore Courses
                </a>
                <a href="/schedule" class="list-group-item list-group-item-action">
                  <i class="fas fa-calendar-alt me-2"></i>My Weekly Schedule
                </a>
                <a href="/profile" class="list-group-item list-group-item-action">
                  <i class="fas fa-user-edit me-2"></i>Edit Profile
                </a>
              </div>
            </div>
          </div>
          
          <!-- Today's Schedule Card -->
          <div class="card mt-4">
            <div class="card-header bg-primary text-white">
              <h3><i class="fas fa-calendar-day me-2"></i>Today's Schedule</h3>
            </div>
            <div class="card-body bg-dark">
              <% 
              // Get today's day of the week
              const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
              const today = daysOfWeek[new Date().getDay()];
              
              // Filter courses for today
              let todayClasses = [];
              
              if (enrolledCourses && enrolledCourses.length > 0) {
                enrolledCourses.forEach(enrollment => {
                  if (enrollment.courseSchedule && enrollment.isActive) {
                    const todaySchedule = enrollment.courseSchedule.filter(session => 
                      session.day.toLowerCase() === today
                    );
                    
                    todaySchedule.forEach(session => {
                      todayClasses.push({
                        time: `${session.startTime} - ${session.endTime}`,
                        course: enrollment.courseName,
                        trainer: enrollment.trainerName
                      });
                    });
                  }
                });
                
                // Sort by start time
                todayClasses.sort((a, b) => {
                  const timeA = a.time.split(' - ')[0];
                  const timeB = b.time.split(' - ')[0];
                  return timeA.localeCompare(timeB);
                });
              }
              %>
              
              <% if (todayClasses && todayClasses.length > 0) { %>
                <div class="table-responsive">
                  <table class="table table-hover table-dark">
                    <thead>
                      <tr>
                        <th class="text-light">Time</th>
                        <th class="text-light">Course</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% todayClasses.forEach(session => { %>
                        <tr>
                          <td class="text-light"><strong><%= session.time %></strong></td>
                          <td class="text-light"><%= session.course %></td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>No classes scheduled for today.
                </div>
              <% } %>
            </div>
          </div>
          
          <!-- Course Reviews Card -->
          <div class="card mt-4">
            <div class="card-header bg-success text-white">
              <h3><i class="fas fa-star me-2"></i>Course Reviews</h3>
            </div>
            <div class="card-body">
              <p>Share your experience with courses you're enrolled in.</p>
              
              <% if (enrolledCourses && enrolledCourses.length > 0) { %>
                <div class="list-group review-courses-list mb-3">
                  <% enrolledCourses.filter(e => e.isActive).forEach(enrollment => { %>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center write-review-btn"
                            data-bs-toggle="modal" 
                            data-bs-target="#reviewModal"
                            data-course-id="<%= enrollment.course._id %>"
                            data-course-name="<%= enrollment.courseName %>">
                      <%= enrollment.courseName %>
                      <span class="badge bg-primary rounded-pill">
                        <i class="fas fa-pen"></i>
                      </span>
                    </button>
                  <% }); %>
                </div>
              <% } else { %>
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>You need to be enrolled in courses to write reviews.
                </div>
              <% } %>
              
              <div class="d-grid">
                <a href="/courses" class="btn btn-outline-success">
                  <i class="fas fa-search me-1"></i>Explore More Courses
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="reviewModalLabel">Write a Review</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="reviewForm" action="/reviews/create" method="POST">
          <div class="modal-body">
            <input type="hidden" id="reviewCourseId" name="courseId" value="">
            
            <div class="mb-3">
              <label for="reviewCourseName" class="form-label">Course</label>
              <input type="text" class="form-control bg-dark text-white" id="reviewCourseName" readonly>
            </div>
            
            <div class="mb-3">
              <label for="rating" class="form-label">Rating</label>
              <div class="star-rating">
                <input type="radio" id="rating5" name="rating" value="5" required><label for="rating5"></label>
                <input type="radio" id="rating4" name="rating" value="4"><label for="rating4"></label>
                <input type="radio" id="rating3" name="rating" value="3"><label for="rating3"></label>
                <input type="radio" id="rating2" name="rating" value="2"><label for="rating2"></label>
                <input type="radio" id="rating1" name="rating" value="1"><label for="rating1"></label>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="comment" class="form-label">Your Review</label>
              <textarea class="form-control bg-dark text-white" id="comment" name="comment" rows="4" required 
                        placeholder="Share your experience with this course..."></textarea>
              <div class="form-text text-light">Your review will help others make better decisions.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit Review</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Add Renew Enrollment Modal/Script -->
  <script>
    document.querySelectorAll('.renew-btn').forEach(button => {
      button.addEventListener('click', function() {
        const enrollmentId = this.getAttribute('data-enrollment-id');
        if (confirm('Would you like to renew this course enrollment for another 4 weeks?')) {
          fetch(`/courses/api/enrollment/${enrollmentId}/renew`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Enrollment renewed successfully for 4 more weeks!');
              window.location.reload();
            } else {
              alert(data.message || 'Failed to renew enrollment. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while renewing enrollment. Please try again later.');
          });
        }
      });
    });
    
    // Handle review modal
    document.querySelectorAll('.write-review-btn').forEach(button => {
      button.addEventListener('click', function() {
        const courseId = this.getAttribute('data-course-id');
        const courseName = this.getAttribute('data-course-name');
        
        document.getElementById('reviewCourseId').value = courseId;
        document.getElementById('reviewCourseName').value = courseName;
      });
    });
    
    // Handle review form submission
    document.getElementById('reviewForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const courseId = document.getElementById('reviewCourseId').value;
      const rating = document.querySelector('input[name="rating"]:checked').value;
      const comment = document.getElementById('comment').value;
      
      // Submit review using fetch
      fetch('/reviews/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          courseId: courseId,
          rating: parseInt(rating),
          comment: comment
        }),
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
        modal.hide();
        
        // Show success message
        alert('Your review has been submitted successfully!');
        
        // Reload page to show the success message
        window.location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('you have already reviewed the course');
      });
    });
  </script>
  
  <style>
    /* Star Rating Styles */
    .star-rating {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-end;
    }
    
    .star-rating input {
      display: none;
    }
    
    .star-rating label {
      cursor: pointer;
      width: 30px;
      height: 30px;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24'%3e%3cpath d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z' fill='%23d4d4d4'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
    }
    
    .star-rating input:checked ~ label {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24'%3e%3cpath d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z' fill='%23ffc107'/%3e%3c/svg%3e");
    }
    
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24'%3e%3cpath d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z' fill='%23ffc107'/%3e%3c/svg%3e");
    }
  </style>
  
<%- include('../partials/footer') %>